---
title: "qpcr_plots"
author: "Juliana Cornett"
date: "2023-10-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#code to generate qPCR plots (Figures 2 in manuscript) and info for Table 1

#install packages (ggplot2, ggpubr, patchwork, & ggpmisc for creating figures; dplyr, tidyr and reshape2 for data manipulation)

```{r}
#install.packages("ggplot2")
#install.packages("ggpubr")
#install.packages("dplyr")
#install.packages("tidyr")
#install.packages("reshape2")
#install.packages("patchwork")
#install.packages("ggpmisc")
```

#load libraries

```{r}
library(ggplot2)
library(ggpubr)
library(dplyr)
library(tidyr)
library(reshape2)
library(patchwork)
library(ggpmisc)
```

#read in qPCR data 

```{r}
qpcr <- read.csv("../Data/Alexandrium_qPCR_Results.csv")
```

#subset to samples only (not blanks)

```{r}
qpcr_samp <- subset(qpcr, qpcr$Sample_Type == "Sample")
```

#subset to remove values below LOD/LOQ (63.98 copies)

```{r}
qpcr_sub <- subset(qpcr_samp, qpcr_samp$Quantity_Mean >= 63.98)
```

#create new df with daily mean quantity

```{r}
Quant_dailyMean <- aggregate(Quantity_Mean ~ Date, data = qpcr_sub, FUN = mean)
Quant_dailyMean$Date <- as.Date(Quant_dailyMean$Date, "%m/%d/%Y")
```

#regressions

#read in microscope data

```{r}
count_micro <- read.csv("../Data/Alexandrium_MicroscopeCounts.csv")
```

#subset to only ID and count data, reformat date, and remove NAs

```{r}
count_sub <- select(count_micro, c("Date", "Week", "Count_1m_L", "Count_5m_L", "Count_Net")) %>% na.omit()
count_sub$Date <- as.Date(count_sub$Date, "%m/%d/%Y")
```

#merge with qpcr data

```{r}
count_qpcr <- merge(Quant_dailyMean, count_sub)
```

```{r}
count_qpcr
```

#linear regression between qpcr and net tow

```{r}

```

#read in ELISA data

```{r}
elisa <- read.csv("../Data/Oyster_PSTs.csv")
```

#reformat 

```{r}
elisa_sub <- subset(elisa, Method == "ELISA") %>% select(c("Date", "Tox_ug_100g")) 
elisa_sub$Date <- as.Date(elisa_sub$Date, "%m/%d/%Y")
```

#merge

```{r}
merge_all <- merge(count_qpcr, elisa_sub)
```

#add log-transformed mean quantity column

```{r}
merge_all$log_qpcrMean <- log(merge_all$Quantity_Mean)
```

#calculate linear regression between qpcr and 1m

```{r}
lm_q_1 <- lm(merge_all$Quantity_Mean ~ merge_all$Count_1m_L)
summary(lm_q_1)
```

#try nonlinear b/c linear not significant

#exponential 

```{r}
exp_q_1 <- lm(log(merge_all$Quantity_Mean) ~ merge_all$Count_1m_L)
summary(exp_q_1)
```

#logarithmic

```{r}
log_q_1 <- lm(merge_all$Quantity_Mean ~ log(merge_all$Count_1m_L))
summary(log_q_1)
```

#quadratic

```{r}
quad_q_1 <- lm(merge_all$Quantity_Mean ~ poly(merge_all$Count_1m_L,2))
summary(quad_q_1)
```

#visualize relationship between qpcr and 1m

```{r}
plot_q_1 <- ggplot(merge_all, aes(Count_1m_L, Quantity_Mean)) + geom_point() + stat_smooth() + theme_pubr()
plot_q_1
```

#calculate linear regression between qpcr and 5m

```{r}
lm_q_5 <- lm(merge_all$Quantity_Mean ~ merge_all$Count_5m_L)
summary(lm_q_5)
```

#try nonlinear b/c non-signficant

#exponential 

```{r}
exp_q_5 <- lm(log(merge_all$Quantity_Mean) ~ merge_all$Count_5m_L)
summary(exp_q_5)
```

#logarithmic

```{r}
log_q_5 <- lm(merge_all$Quantity_Mean ~ log(merge_all$Count_5m_L))
summary(log_q_5)
```

#quadratic

```{r}
quad_q_5 <- lm(merge_all$Quantity_Mean ~ poly(merge_all$Count_5m_L,2))
summary(quad_q_5)
```


#visualize relationship between qpcr and 5m

```{r}
plot_q_5 <- ggplot(merge_all, aes(Count_5m_L, Quantity_Mean)) + geom_point() + stat_smooth() + theme_pubr()
plot_q_5
```

#calculate linear regression between qpcr and elisa

```{r}
lm_q_elisa <- lm(merge_all$Tox_ug_100g ~ merge_all$Quantity_Mean)
summary(lm_q_elisa)
```

#try nonlinear b/c linear non-significant

#exponential

```{r}
exp_q_elisa <- lm(log(merge_all$Tox_ug_100g) ~ merge_all$Quantity_Mean)
summary(exp_q_elisa)
```

#logarithmic

```{r}
log_q_elisa <- lm(merge_all$Tox_ug_100g ~ log(merge_all$Quantity_Mean))
summary(log_q_elisa)
```

#quadratic

```{r}
quad_q_elisa <- lm(merge_all$Tox_ug_100g ~ poly(merge_all$Quantity_Mean,2))
summary(quad_q_elisa)
```

#visualize relationship between qpcr and elisa

```{r}
plot_q_elisa <- ggplot(merge_all, aes(Quantity_Mean, Tox_ug_100g)) + geom_point() + stat_smooth(method = "lm", formula = y ~ poly(x, 2)) + theme_pubr()
plot_q_elisa
```


#Figure w/ qpcr and count data regressions vs. ELISA tox data

```{r}
plot_1m_5m <- gather(merge_all, key = Depth, value = Count, 
       Count_1m_L, Count_5m_L) %>%
  ggplot(aes(x=Count, y = Tox_ug_100g, group = Depth, colour = Depth, fill = Depth)) + 
  scale_fill_manual(values = c("#F9B282", "#ED7C97"), labels = c("1m", "5m")) +
  scale_color_manual(values = c("#F9B282", "#ED7C97"), labels = c("1m", "5m")) +
    geom_point(size = 5, shape = 21, color = "black") + 
  geom_smooth(method = "lm", se = FALSE, size = 3) +
  theme_pubr() +
  theme(legend.position = "right") +
  labs(x = "Alexandrium count (cells/L)", y = "PSTs (ug/100g)") + 
  annotate("text", x=0, y=250, label = "A", size = 5)
plot_1m_5m
```

```{r}
plot_qpcr <- ggplot(merge_all, aes(x=Quantity_Mean, y = Tox_ug_100g)) + 
  geom_point(size = 5, shape = 21, color = "black", fill = "#BC5AA9") + 
  stat_smooth(method = "lm", se = FALSE, size = 3, color = "#BC5AA9", formula = y ~ poly(x, 2)) +
  theme_pubr() +
  labs(x = "A. catenella quantity (log10 copy number/L)", y = "PSTs (ug/100g)") + 
  annotate("text", x=350, y=250, label = "B", size = 5) +
  scale_x_continuous(trans="log10") 
plot_qpcr
```

#save as jpeg

```{r}
jpeg("../Figures/Fig7.jpg", width = 8, height = 10, units="in", res=600)
plot_1m_5m /
  plot_qpcr
```


#plot of qPCR vs. 1m and 5m - x-axis is copy number/L; y-axis is cells/L (for poster)

#read in csv

```{r}
count_depths <- read.csv("../Data/Count_qPCR_Depths.csv")
```

```{r}
qpcr_mic_corr <- ggplot(count_depths, aes(x = Quantity_Mean, y = Count_L, color = Depth, fill = Depth, shape = Depth)) + 
  scale_fill_manual(values = c("darkgray", "black"), labels = c("1m", "5m")) +
  scale_color_manual(values = c("darkgray", "black"), labels = c("1m", "5m")) +
  scale_shape_manual(values = c(21,24)) +
  geom_point(size = 4, color = "black", alpha = 0.75) + 
  stat_poly_line(se = FALSE, size = 2) +
  stat_poly_eq(use_label(c("R2", "p"))) +
  scale_x_continuous(trans="log10") +
  theme_pubr() +
  xlab("Mean A. catenella qPCR Quantity (Copy Number/L; Log-transformed)") +
  ylab("Alexandrium Microscope Count (Cells/L)") +
  theme(legend.position = "right")
qpcr_mic_corr
```

#add log-transformed qpcr column

```{r}
count_depths$log_qpcr <- log(count_depths$Quantity_Mean)
```

#calculate linear regression between 1m and qpcr

```{r}
lm_1m_qpcr <- subset(count_depths, Depth == "1m") 
lm_1m_qpcr <- lm(lm_1m_qpcr$log_qpcr ~ lm_1m_qpcr$Count_L)
summary(lm_1m_qpcr)
```

#calculate linear regression between 5m and qpcr

```{r}
lm_5m_qpcr <- subset(count_depths, Depth == "5m") 
lm_5m_qpcr <- lm(lm_5m_qpcr$log_qpcr ~ lm_5m_qpcr$Count_L)
summary(lm_5m_qpcr)
```

#save as jpeg

```{r}
jpeg("../Figures/qPCR_Microscope_Correlation.jpg", width = 8, height = 5, units="in", res=600)
qpcr_mic_corr
```
