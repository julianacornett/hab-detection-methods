---
title: "qpcr_plots"
author: "Juliana Cornett"
date: "2023-10-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#code to generate qPCR plots (Figure(s) __ in manuscript)

#install packages (ggplot2 & ggpubr for creating figures; dplyr and reshape2 for data manipulation, ggdist for violin plot)

```{r}
#install.packages("ggplot2")
#install.packages("ggpubr")
#install.packages("dplyr")
#install.packages("reshape2")
#install.packages("ggdist")
#install.packages("ggtext")
#install.packages("colorspace")
#install.packages("ragg")
```

#load libraries

```{r}
library(ggplot2)
library(ggpubr)
library(dplyr)
library(reshape2)
library(ggdist)
library(ggtext)
library(colorspace)
library(ragg)
```

#read in qPCR data 

```{r}
qpcr <- read.csv("../Data/Alexandrium_qPCR_Results.csv")
```

#reformat

```{r}
qpcr$Date <- as.Date(qpcr$Date, "%m/%d/%Y")
qpcr$Quantity_1 <- as.numeric(gsub(",", "", qpcr$Quantity_1))
qpcr$Quantity_2 <- as.numeric(gsub(",", "", qpcr$Quantity_2))
qpcr$Quantity_3 <- as.numeric(gsub(",", "", qpcr$Quantity_3))
qpcr$Quantity_Mean <- as.numeric(gsub(",", "", qpcr$Quantity_Mean))
qpcr$Cells_L <- as.numeric(gsub(",", "", qpcr$Cells_L))
```

#extract month 

```{r}
qpcr$Month <- format(as.Date(qpcr$Date, format="%d/%m/%Y"),"%b")
```

#subset to samples only (not blanks)

```{r}
qpcr_samp <- subset(qpcr, qpcr$Sample_Type == "Sample")
```

#palettes

```{r}
sunset_5 <- hcl.colors(5, palette = "Sunset")
```

#scatterplot

```{r}
qpcr_samp$Month <- factor(qpcr_samp$Month, levels = c("May", "Jun", "Jul", "Aug", "Sep"))

plot_qpcr_scatter <- ggplot(qpcr_samp, aes(x = Date, y = Quantity_Mean)) +
  geom_point(aes(y = Quantity_Mean, fill = Month), size = 5, shape = 21) + 
  scale_fill_manual(values = sunset_5) +
  labs(y = "Copy number (log-transformed)") + 
  theme_pubr() +
  theme(legend.position = "right") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  scale_y_continuous(trans="log10")
plot_qpcr_scatter
```

#save as jpeg

```{r}
jpeg("../Figures/Fig4.jpg", width = 8, height = 5, units="in", res=600)
plot_qpcr_scatter
```

#raincloud plot

#read in microscope data

```{r}
count_micro <- read.csv("../Data/Alexandrium_MicroscopeCounts.csv")
```

#subset to only ID and count data

```{r}
count_sub <- select(count_micro, c("ID_yyyymmdd", "Count_1m_L", "Count_5m_L"))
```

#gather into long form

```{r}
count_long <- melt(count_sub, id.vars = "ID_yyyymmdd", variable.name = "Method")
```

#select only ID_yyyymmdd & Cells_L from eDNA sample-only dataframe

```{r}
qpcr_samp_sub <- select(qpcr_samp, c("ID_yyyymmdd", "Cells_L"))
```

#add "Method" column filled with "qPCR"

```{r}
qpcr_samp_sub$Method <- "qPCR"
```

#rename Cells_L to "value" to match

```{r}
qpcr_samp_sub <- qpcr_samp_sub %>% rename("value" = "Cells_L")
```

```{r}
qpcr_samp_sub$value <- as.integer(qpcr_samp_sub$value)
```

#append to long-form microscope count df

```{r}
count_qpcr <- rbind(count_long, qpcr_samp_sub)
```

#plot

```{r}
pal <-  hcl.colors(3, palette = "Sunset")

plot_qpcr_raincloud <- ggplot(count_qpcr, aes(x = factor(Method), y = value)) + 
  ggdist::stat_halfeye(
    aes(color = Method,
        fill = after_scale(lighten(color, .5))), adjust = .5, 
    width = .75, 
    .width = 0,
    justification = -.4, 
    point_color = NA,
    normalize = "groups") + 
  geom_boxplot(
    aes(color = Method,
        color = after_scale(darken(color, .1, space = "HLS")),
        fill = after_scale(desaturate(lighten(color, .8), .4))),
    width = .42, 
    outlier.shape = NA
  ) +
  geom_point(
    aes(color = Method,
        color = after_scale(darken(color, .1, space = "HLS"))),
    fill = "white",
    shape = 21,
    stroke = .4,
    size = 2,
    position = position_jitter(seed = 1, width = .12)
  ) + 
  geom_point(
    aes(fill = Method),
    color = "transparent",
    shape = 21,
    stroke = .4,
    size = 2,
    alpha = .3,
    position = position_jitter(seed = 1, width = .12)) + 
  stat_summary(
    geom = "text",
    fun = "median",
    aes(label = round(..y.., 2),
        color = Method,
        color = after_scale(darken(color, .1, space = "HLS"))),
    fontface = "bold",
    size = 3.5,
    vjust = -3.75
  ) +
#  coord_flip() +
  scale_color_manual(values = pal, guide = "none") +
  scale_fill_manual(values = pal, guide = "none") +
  labs(
    x = NULL,
    y = "Alexandrium count (cells/L)"
  ) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.ticks = element_blank(),
    axis.text.y = element_text(size = 10),
    axis.title.x = element_text(margin = margin(t = 10),
                                size = 10)
  ) +
  scale_x_discrete(labels=c("qPCR" = "qPCR (2m)", "Count_5m_L" = "Microscope (5m)", "Count_1m_L" = "Microscope (1m)"))
plot_qpcr_raincloud
```
```{r}
pal <-  hcl.colors(3, palette = "Sunset")

ggplot(count_qpcr, aes(x = Method, y = value, fill = Method, color = Method)) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  ggdist::stat_halfeye(adjust = .5, width = .7, .width = 0, justification = -.2, point_colour = NA, normalize = "groups") + 
  geom_boxplot(width = .2, outlier.shape = NA, alpha = 0.5) + 
  geom_jitter(width = .05, shape = 21) +
  theme_pubr()
```

#save as jpeg

```{r}
#jpeg("../Figures/Fig5.jpg", width = 8, height = 5, units="in", res=600)
#plot_qpcr_raincloud
```
