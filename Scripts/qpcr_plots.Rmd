---
title: "qpcr_plots"
author: "Juliana Cornett"
date: "2023-10-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#code to generate qPCR plots (Figures 5-7 in manuscript)

#install packages (ggplot2, ggpubr, & patchwork for creating figures; dplyr, tidyr and reshape2 for data manipulation)

```{r}
#install.packages("ggplot2")
#install.packages("ggpubr")
#install.packages("dplyr")
#install.packages("tidyr")
#install.packages("reshape2")
#install.packages("patchwork")
#install.packages("remotes")
```

#load libraries

```{r}
library(ggplot2)
library(ggpubr)
library(dplyr)
library(tidyr)
library(reshape2)
library(patchwork)
source("https://gist.github.com/ellisp/4002241def4e2b360189e58c3f461b4a/raw/0e5dc52262e86b5d21b914db3553e58b0b8d1d20/dualplot.R")     
```

#read in qPCR data 

```{r}
qpcr <- read.csv("../Data/Alexandrium_qPCR_Results.csv")
```

#reformat

```{r}
qpcr$Date <- as.Date(qpcr$Date, "%m/%d/%Y")
```

#extract month 

```{r}
qpcr$Month <- format(as.Date(qpcr$Date, format="%d/%m/%Y"),"%b")
```

#subset to samples only (not blanks)

```{r}
qpcr_samp <- subset(qpcr, qpcr$Sample_Type == "Sample")
```

#subset to remove values below LOD/LOQ (63.98 copies)

```{r}
qpcr_sub <- subset(qpcr_samp, qpcr_samp$Quantity_Mean >= 63.98)
```

#create new df with daily mean quantity

```{r}
Quant_dailyMean <- aggregate(Quantity_Mean ~ Date, data = qpcr_sub, FUN = mean)
```

#extract month 

```{r}
Quant_dailyMean$Month <- format(as.Date(Quant_dailyMean$Date, format="%d/%m/%Y"),"%b")
```

#palettes

```{r}
sunset_5 <- hcl.colors(5, palette = "Sunset")
```

#scatterplot

```{r}
qpcr_sub$Month <- factor(qpcr_sub$Month, levels = c("May", "Jun", "Jul", "Aug", "Sep"))

#add shading for time when farm was testing >80 ug/100g at DEC (6/6/23-7/7/23; 9/25/23-9/28/23) 
plot_qpcr_scatter_dec <- ggplot(qpcr_sub, aes(x = Date, y = Quantity_Mean)) +
  geom_point(aes(y = Quantity_Mean, fill = Month), size = 5, shape = 21) + 
  scale_fill_manual(values = sunset_5) +
  labs(y = "Alexandrium quantity (log10 copy number/L)") + 
  theme_pubr() +
  theme(legend.position = "right") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  scale_y_continuous(trans="log10") + 
  annotate("rect",
           xmin=as.Date("2023-06-06"), xmax=as.Date("2023-06-19"), ymin = 0, ymax=Inf, fill = "#F3E79A", alpha=.35) + 
  annotate("rect",
           xmin=as.Date("2023-06-24"), xmax=as.Date("2023-07-07"), ymin = 0, ymax=Inf, fill = "#F3E79A", alpha=.35) + 
  annotate("rect",
           xmin=as.Date("2023-09-25"), xmax=as.Date("2023-09-28"), ymin = 0, ymax=Inf, fill = "#F3E79A", alpha=.35) +
  annotate("text", x=as.Date("2023-05-01"), y=1e+06, label = "A", size = 5) +
  theme(axis.title.x = element_blank()) 
plot_qpcr_scatter_dec

#add shading for time when farm was testing >80 ug/100g w/ ELISAs (6/6/23-7/10/23; 7/18/23-7/24/23)
plot_qpcr_scatter_elisa <- ggplot(qpcr_sub, aes(x = Date, y = Quantity_Mean)) +
  geom_point(aes(y = Quantity_Mean, fill = Month), size = 5, shape = 21) + 
  scale_fill_manual(values = sunset_5) +
  labs(y = "Alexandrium quantity (log10 copy number/L)") + 
  theme_pubr() +
  theme(legend.position = "right") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  scale_y_continuous(trans="log10") + 
  annotate("rect",
           xmin=as.Date("2023-06-06"), xmax=as.Date("2023-07-10"), ymin = 0, ymax=Inf, fill = "#704D9E", alpha=.25) + 
  annotate("rect",
           xmin=as.Date("2023-07-18"), xmax=as.Date("2023-07-24"), ymin = 0, ymax=Inf, fill = "#704D9E", alpha=.25) + 
  annotate("text", x=as.Date("2023-05-01"), y=1e+06, label = "B", size = 5) +
  theme(axis.title.x = element_blank()) 
plot_qpcr_scatter_elisa

```

#save as jpeg

```{r}
jpeg("../Figures/Fig6.jpg", width = 8, height = 10, units="in", res=600)
plot_qpcr_scatter_dec /
  plot_qpcr_scatter_elisa
```

#regressions

#read in microscope data

```{r}
count_micro <- read.csv("../Data/Alexandrium_MicroscopeCounts.csv")
```

#subset to only ID and count data, reformat date, and remove NAs

```{r}
count_sub <- select(count_micro, c("Date", "Week", "Count_1m_L", "Count_5m_L", "Count_Net")) %>% na.omit()
count_sub$Date <- as.Date(count_sub$Date, "%m/%d/%Y")
```

#merge with qpcr data

```{r}
count_qpcr <- merge(Quant_dailyMean, count_sub)
```

#read in ELISA data

```{r}
elisa <- read.csv("../Data/Oyster_PSTs.csv")
```

#reformat 

```{r}
elisa_sub <- subset(elisa, Method == "ELISA") %>% select(c("Date", "Tox_ug_100g")) 
elisa_sub$Date <- as.Date(elisa_sub$Date, "%m/%d/%Y")
```

#merge

```{r}
merge_all <- merge(count_qpcr, elisa_sub)
```

#calculate linear regression between qpcr and 1m

```{r}
lm_q_1 <- lm(merge_all$Quantity_Mean ~ merge_all$Count_1m_L)
summary(lm_q_1)
```
#try nonlinear b/c linear not significant

#exponential 

```{r}
exp_q_1 <- lm(log(merge_all$Quantity_Mean) ~ merge_all$Count_1m_L)
summary(exp_q_1)
```

#logarithmic

```{r}
log_q_1 <- lm(merge_all$Quantity_Mean ~ log(merge_all$Count_1m_L))
summary(log_q_1)
```

#quadratic

```{r}
quad_q_1 <- lm(merge_all$Quantity_Mean ~ poly(merge_all$Count_1m_L,2))
summary(quad_q_1)
```

#visualize relationship between qpcr and 1m

```{r}
plot_q_1 <- ggplot(merge_all, aes(Count_1m_L, Quantity_Mean)) + geom_point() + stat_smooth() + theme_pubr()
plot_q_1
```

#calculate linear regression between qpcr and 5m

```{r}
lm_q_5 <- lm(merge_all$Quantity_Mean ~ merge_all$Count_5m_L)
summary(lm_q_5)
```

#try nonlinear b/c non-signficant

#exponential 

```{r}
exp_q_5 <- lm(log(merge_all$Quantity_Mean) ~ merge_all$Count_5m_L)
summary(exp_q_5)
```

#logarithmic

```{r}
log_q_5 <- lm(merge_all$Quantity_Mean ~ log(merge_all$Count_5m_L))
summary(log_q_5)
```

#quadratic

```{r}
quad_q_5 <- lm(merge_all$Quantity_Mean ~ poly(merge_all$Count_5m_L,2))
summary(quad_q_5)
```


#visualize relationship between qpcr and 5m

```{r}
plot_q_5 <- ggplot(merge_all, aes(Count_5m_L, Quantity_Mean)) + geom_point() + stat_smooth() + theme_pubr()
plot_q_5
```

#calculate linear regression between qpcr and elisa

```{r}
lm_q_elisa <- lm(merge_all$Tox_ug_100g ~ merge_all$Quantity_Mean)
summary(lm_q_elisa)
```

#try nonlinear b/c linear non-significant

#exponential

```{r}
exp_q_elisa <- lm(log(merge_all$Tox_ug_100g) ~ merge_all$Quantity_Mean)
summary(exp_q_elisa)
```

#logarithmic

```{r}
log_q_elisa <- lm(merge_all$Tox_ug_100g ~ log(merge_all$Quantity_Mean))
summary(log_q_elisa)
```

#quadratic

```{r}
quad_q_elisa <- lm(merge_all$Tox_ug_100g ~ poly(merge_all$Quantity_Mean,2))
summary(quad_q_elisa)
```

#visualize relationship between qpcr and elisa

```{r}
plot_q_elisa <- ggplot(merge_all, aes(Quantity_Mean, Tox_ug_100g)) + geom_point() + stat_smooth(method = "lm", formula = y ~ poly(x, 2)) + theme_pubr()
plot_q_elisa
```

#Figure of count data (1m, 5m) on one y-axis and qpcr count data on other y-axis 

```{r}
coeff <- 100

count_plot <- ggplot(merge_all, aes(x=Date)) +
  
  geom_line( aes(y=Count_1m_L), color = "#F9B282", size = 3, alpha = 0.75) + 
  geom_line( aes(y=Count_5m_L), color = "#ED7C97", size = 3, alpha = 0.75) +
  geom_line( aes(y=Quantity_Mean / coeff), color = "#BC5AA9", size = 3, alpha = 0.75) + 
  scale_y_continuous(
    name = "Alexandrium count (cells/L)",
    sec.axis = sec_axis(~.*coeff, name="Alexandrium quantity (copy number/L)")
  ) +
  theme_pubr() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") + 
  theme(
    axis.title.y = element_text(color = "#F48E8E"),
    axis.title.y.right = element_text(color = "#BC5AA9"),
     axis.title.x = element_blank()) +
  annotate("text", x=as.Date("2023-06-18"), y=2600, label = "2m qPCR", size = 4, color = "#BC5AA9") +
  annotate("text", x=as.Date("2023-07-22"), y=1300, label = "1m microscope", size = 4, color = "#F9B282") +
  annotate("text", x=as.Date("2023-08-05"), y=1000, label = "5m microscope", size = 4, color = "#ED7C97")
count_plot
```

#save as jpeg

```{r}
jpeg("../Figures/Fig5.jpg", width = 8, height = 5, units="in", res=600)
count_plot
```

#Figure w/ qpcr and count data regressions vs. ELISA tox data

```{r}
plot_1m_5m <- gather(merge_all, key = Depth, value = Count, 
       Count_1m_L, Count_5m_L) %>%
  ggplot(aes(x=Count, y = Tox_ug_100g, group = Depth, colour = Depth, fill = Depth)) + 
  scale_fill_manual(values = c("#F9B282", "#ED7C97"), labels = c("1m", "5m")) +
  scale_color_manual(values = c("#F9B282", "#ED7C97"), labels = c("1m", "5m")) +
    geom_point(size = 5, shape = 21, color = "black") + 
  geom_smooth(method = "lm", se = FALSE, size = 3) +
  theme_pubr() +
  theme(legend.position = "right") +
  labs(x = "Alexandrium count (cells/L)", y = "PSTs (ug/100g)") + 
  annotate("text", x=0, y=250, label = "A", size = 5)
plot_1m_5m
```

```{r}
plot_qpcr <- ggplot(merge_all, aes(x=Quantity_Mean, y = Tox_ug_100g)) + 
  geom_point(size = 5, shape = 21, color = "black", fill = "#BC5AA9") + 
  stat_smooth(method = "lm", se = FALSE, size = 3, color = "#BC5AA9", formula = y ~ poly(x, 2)) +
  theme_pubr() +
  labs(x = "Alexandrium quantity (log10 copy number/L)", y = "PSTs (ug/100g)") + 
  annotate("text", x=350, y=250, label = "B", size = 5) +
  scale_x_continuous(trans="log10") 
plot_qpcr
```

#save as jpeg

```{r}
jpeg("../Figures/Fig7.jpg", width = 8, height = 10, units="in", res=600)
plot_1m_5m /
  plot_qpcr
```

#t test of net tow vs. quant variables (1m, 5m, elisa, qpcr)

#create new categorical column - presence/absence in net tow as alpha values

```{r}
merge_all$Presence_NetTow <- ifelse(merge_all$Count_Net==0, "No", "Yes")
```

#t test of net tow vs. 1m

```{r}
t.test(Count_1m_L ~ Presence_NetTow, data = merge_all)
```

#t test of net tow vs. 5m

```{r}
t.test(Count_5m_L ~ Presence_NetTow, data = merge_all)
```

#t test of net tow vs. elisa

```{r}
t.test(Tox_ug_100g ~ Presence_NetTow, data = merge_all)
```

#t test of net tow vs. qpcr

```{r}
t.test(Quantity_Mean ~ Presence_NetTow, data = merge_all)
```

#ANOVAs

#read in tox data again and subset to only DEC and reformat date

```{r}
tox_dec <- read.csv("../Data/Oyster_PSTs.csv") %>% subset(Method == "DEC")
tox_dec$Date <- as.Date(tox_dec$Date, (format="%d/%m/%Y"))
```

#create new categorical column in tox data with 3 values: 1) <34 ug/100g, 2) >34 and <80 ug/100g, 3) >80 ug/100g

```{r}
tox_dec$threshold <- ifelse(tox_dec$Tox_ug_100g == 34, "<34 ug/100g", ifelse(tox_dec$Tox_ug_100g >= 80, ">80 ug/100g", ">34 and <80 ug/100g"))
```

#subset to week and threshold only

```{r}
tox_sub <- select(tox_dec, c("Week", "threshold"))
```

#merge w/ merge_all df

```{r}
merge_aov <- merge(merge_all, tox_sub)
```

#ANOVA of dec tox vs. 1m

```{r}
aov_1m <- aov(Count_1m_L ~ as.factor(threshold), data = merge_aov)
summary(aov_1m)
```

```{r}
TukeyHSD(aov_1m)
```

#ANOVA of dec tox vs. 5m

```{r}
aov_5m <- aov(Count_5m_L ~ as.factor(threshold), data = merge_aov)
summary(aov_5m)
```

#ANOVA of dec tox vs. elisa

```{r}
aov_elisa <- aov(Tox_ug_100g ~ as.factor(threshold), data = merge_aov)
summary(aov_elisa)
```

```{r}
TukeyHSD(aov_elisa)
```

#ANOVA of dec tox vs. qpcr

```{r}
aov_qpcr <- aov(Quantity_Mean ~ as.factor(threshold), data = merge_aov)
summary(aov_qpcr)
```
